# Makefile for testing empty pipeline
# This tests the core's ability to run without physics dependencies

# Directory setup
TEST_DIR := $(shell dirname $(realpath $(lastword $(MAKEFILE_LIST))))
ROOT_DIR := $(shell dirname $(TEST_DIR))
SRC_DIR := $(ROOT_DIR)/src
CORE_DIR := $(SRC_DIR)/core
PHYSICS_DIR := $(SRC_DIR)/physics
IO_DIR := $(SRC_DIR)/io
INPUT_DIR := $(ROOT_DIR)/input
OUTPUT_DIR := $(ROOT_DIR)/output

# Compiler options
CC = gcc
CFLAGS = -DHDF5 -O2 -march=native -std=gnu99 -fPIC -g -Wall -Wextra
INCLUDES = -I$(ROOT_DIR) -I$(SRC_DIR) -I$(CORE_DIR) -I$(PHYSICS_DIR) -I/opt/homebrew/include
LDFLAGS = -L/opt/homebrew/lib
LIBS = -lhdf5 -lhdf5_hl -lm

# Source files for test
TEST_SOURCES = test_empty_pipeline.c
TEST_EXECUTABLE = test_empty_pipeline

# Core library files
CORE_SOURCES = $(CORE_DIR)/core_init.c \
               $(CORE_DIR)/core_logging.c \
               $(CORE_DIR)/core_mymalloc.c \
               $(CORE_DIR)/core_allvars.c \
               $(CORE_DIR)/core_build_model.c \
               $(CORE_DIR)/core_read_parameter_file.c \
               $(CORE_DIR)/core_module_system.c \
               $(CORE_DIR)/core_pipeline_system.c \
               $(CORE_DIR)/core_event_system.c \
               $(CORE_DIR)/core_evolution_diagnostics.c \
               $(CORE_DIR)/core_module_callback.c \
               $(CORE_DIR)/core_properties.c \
               $(CORE_DIR)/standard_properties.c \
               $(CORE_DIR)/core_properties_sync.c \
               $(CORE_DIR)/core_galaxy_extensions.c \
               $(CORE_DIR)/physics_pipeline_executor.c \
               $(PHYSICS_DIR)/placeholder_empty_module.c \
               $(IO_DIR)/io_module_registry.c

CORE_OBJECTS = $(CORE_SOURCES:.c=.o)

# Input parameter file
PARAM_FILE := $(INPUT_DIR)/empty_pipeline_parameters.par

# Default target
all: setup $(TEST_EXECUTABLE)

# Setup directories and links
setup:
	@mkdir -p $(OUTPUT_DIR)
	@ln -sf $(TEST_DIR)/test_data/trees_063.0 $(INPUT_DIR)/trees_063.0 2>/dev/null || true
	@ln -sf $(TEST_DIR)/test_data/millennium.a_list $(INPUT_DIR)/millennium.a_list 2>/dev/null || true

# Compile core objects
%.o: %.c
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# Link test executable
$(TEST_EXECUTABLE): $(TEST_SOURCES) $(CORE_OBJECTS)
	$(CC) $(CFLAGS) $(INCLUDES) -o $@ $^ $(LDFLAGS) $(LIBS)

# Run the test
run: $(TEST_EXECUTABLE)
	@echo "Testing empty pipeline execution..."
	@echo "Using parameter file: $(PARAM_FILE)"
	./$(TEST_EXECUTABLE) $(PARAM_FILE)

# Clean up
clean:
	@echo "Cleaning up empty pipeline test output..."
	@rm -f $(TEST_EXECUTABLE) $(OUTPUT_DIR)/empty_pipeline_*.hdf5 $(CORE_OBJECTS)
	@rm -f *.o

# Detailed compiler output for debugging build issues
verbose: CFLAGS += -v
verbose: all

.PHONY: all setup run clean verbose
