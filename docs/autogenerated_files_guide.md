# Auto-Generated Files Guide for SAGE Model

## Overview

SAGE uses a metadata-driven architecture where critical system components are automatically generated from YAML definitions at build time. This approach ensures consistency, type safety, and separation of concerns between core infrastructure and physics implementations.

## Auto-Generated File System

### Core Components

The SAGE model automatically generates the following files during compilation:

1. **Property System Files** (from `src/properties.yaml`)
   - `src/core/core_properties.h` - Property definitions and accessor declarations
   - `src/core/core_properties.c` - Property implementation and type-safe accessors
   - `src/core/generated_output_transformers.c` - Output transformation dispatch system

2. **Parameter System Files** (from `src/parameters.yaml`)
   - `src/core/core_parameters.h` - Parameter definitions and accessor declarations  
   - `src/core/core_parameters.c` - Parameter implementation with validation

### Generation Process

All files are generated by `src/generate_property_headers.py` which:
- Reads YAML metadata definitions
- Generates type-safe C code with comprehensive validation
- Includes proper file headers with generation timestamps
- Integrates with the build system for automatic regeneration

## Property System (`properties.yaml`)

### Purpose
Defines all galaxy properties used throughout SAGE, enabling:
- **Core-Physics Separation**: Core properties always available, physics properties module-dependent
- **Type Safety**: Auto-generated accessor functions prevent type errors
- **Memory Optimization**: Build-time control over which properties to include
- **Dynamic Arrays**: Runtime-sized arrays based on simulation parameters

### Key Features

#### Property Categories
- **Core Properties** (`is_core: true`): Essential infrastructure fields always present
- **Physics Properties** (`is_core: false`): Module-specific properties included based on build configuration

#### Build Modes
```bash
make physics-free      # Core properties only (25/57) - fastest, minimal memory
make full-physics      # All properties (57/57) - maximum compatibility  
make custom-physics CONFIG=file.json  # Properties for specific modules
```

#### Property Access Patterns
```c
// Core properties - direct access allowed in core code  
GALAXY_PROP_SnapNum(galaxy) = 42;
GALAXY_PROP_merged(galaxy) = 0;  // New core property for lifecycle management

// Physics properties - must use generic accessors from core code
property_id_t mergtime_id = get_property_id("MergTime");
if (has_property(galaxy, mergtime_id)) {
    set_float_property(galaxy, mergtime_id, 5.2f);
    float mergtime = get_float_property(galaxy, mergtime_id, 999.9f);
}
```

### YAML Structure
```yaml
properties:
  - name: "PropertyName"
    type: "float|int32_t|double|long long|uint64_t"
    units: "Physical units"
    description: "Detailed description"
    is_core: true|false
    is_array: false|true
    array_len: 3|STEPS|0  # 0 for dynamic arrays
    size_parameter: "simulation.NumSnapOutputs"  # For dynamic arrays
    output_field: true|false
    read_only_level: 0|1|2
    output_transformer_function: "function_name"  # Optional
```

## Parameter System (`parameters.yaml`)

### Purpose
Defines all runtime parameters used throughout SAGE, enabling:
- **Physics-Agnostic Core**: Core infrastructure has no hardcoded physics parameter knowledge
- **Type Safety**: Auto-generated parameter parsing with validation
- **Backward Compatibility**: Maintains existing `.par` file format
- **Extensibility**: Easy addition of new parameters without core code changes

### Key Features

#### Parameter Categories
- **Core Parameters**: I/O, simulation, cosmology, units, runtime settings
- **Physics Parameters**: Flags, physics constants, module-specific values

#### Type Safety & Validation
- Automatic type conversion from string to target type
- Bounds checking for numeric parameters
- Enum validation for special parameter types (TreeType, ForestDistributionScheme)
- Comprehensive error handling with descriptive messages

#### Parameter Access
```c
// Auto-generated parameter access
parameter_id_t param_id = get_parameter_id("SfrEfficiency");
if (set_parameter_from_string(run_params, param_id, "0.02") != 0) {
    LOG_ERROR("Failed to set parameter");
}
```

### YAML Structure
```yaml
parameters:
  core:
    io:
      - name: "FileNameGalaxies"
        type: string
        description: "Base name for galaxy output files"
        category: core
        required: true
        struct_field: "io.FileNameGalaxies"
  physics:
    general:
      - name: "SfrEfficiency"
        type: double
        description: "Star formation efficiency parameter"
        category: physics
        required: true
        bounds: {min: 0.0, max: 1.0}
        struct_field: "physics.SfrEfficiency"
```

## File Management

### Build Integration

Auto-generated files are integrated into the build system via:
- **Dependency Tracking**: Files regenerated when YAML definitions change
- **Stamp System**: Prevents unnecessary regeneration
- **Build Targets**: Different property configurations for different use cases

### Version Control

Auto-generated files are handled specially in version control:
- **Included in Repository**: For visibility and debugging
- **Marked in .gitignore**: Flagged as auto-generated to prevent direct editing
- **Proper Headers**: All files include generation timestamps and warnings

### File Headers

All auto-generated files include standardized headers:
```c
/**
 * @file filename.c
 * @brief Auto-generated [component] for SAGE model
 *
 * This file is automatically generated from [source].yaml by
 * generate_property_headers.py. DO NOT EDIT DIRECTLY.
 *
 * Generated on: YYYY-MM-DD HH:MM:SS
 */
```

## Development Guidelines

### When to Modify YAML Files

**Properties (`properties.yaml`):**
- Adding new galaxy properties for physics modules
- Changing property types or array dimensions
- Adjusting core vs physics categorization
- Adding output transformers for complex derivations

**Parameters (`parameters.yaml`):**
- Adding new runtime parameters
- Changing parameter types or validation rules
- Adjusting parameter categorization
- Adding bounds checking for numeric parameters

### Code Generation Process

1. **Edit YAML File**: Modify `src/properties.yaml` or `src/parameters.yaml`
2. **Automatic Regeneration**: Build system detects changes and regenerates files
3. **Compilation**: New C files are compiled into the executable
4. **Testing**: Verify changes with appropriate test suite

### Best Practices

#### YAML Maintenance
- **Consistent Naming**: Use descriptive, consistent property/parameter names
- **Comprehensive Documentation**: Include detailed descriptions and units
- **Proper Categorization**: Correctly mark core vs physics properties/parameters
- **Version Control**: Commit YAML changes with descriptive messages

#### Generated Code Usage
- **Never Edit Directly**: Always modify YAML sources, not generated C files
- **Use Type-Safe Accessors**: Use generated accessor functions for all property/parameter access
- **Follow Access Patterns**: Respect core-physics separation in accessor usage
- **Error Handling**: Check return values from accessor functions

## Troubleshooting

### Common Issues

#### Build Failures
- **Missing Dependencies**: Ensure Python 3 and PyYAML are available
- **YAML Syntax Errors**: Validate YAML files using online validators
- **Property Conflicts**: Check for duplicate property names or IDs

#### Runtime Errors
- **Property Access Failures**: Verify property exists in current build configuration
- **Parameter Validation Failures**: Check parameter values against defined bounds
- **Memory Issues**: Ensure dynamic array sizes are properly resolved

#### Generated File Issues
- **Missing Headers**: Verify all auto-generated files have proper headers
- **Compilation Errors**: Check for YAML syntax issues or unsupported types
- **Inconsistent Behavior**: Clean and rebuild to ensure all files are current

### Debug Information

The generation script provides verbose output:
```bash
cd src && python3 generate_property_headers.py --all-properties --generate-parameters
```

Build system shows generation status:
```bash
make clean && make  # Shows property/parameter generation steps
```

## Future Development

### Extension Points

The auto-generated file system is designed for easy extension:
- **New Property Types**: Add support for additional C data types
- **Enhanced Validation**: Implement more sophisticated bounds checking
- **Cross-References**: Support for parameter-dependent property definitions
- **Module Integration**: Automatic generation of module-specific interfaces

### Architecture Evolution

The metadata-driven approach enables:
- **Physics Module Development**: New modules can define their own properties/parameters
- **Scientific Validation**: Consistent interfaces enable automated testing
- **Performance Optimization**: Build-time configuration for minimal memory usage
- **Multi-Language Support**: YAML definitions could target other language backends

## Implementation Status (June 2025)

### âœ… Successfully Deployed in Production

The auto-generated file system has been successfully implemented and is now the foundation of SAGE's modular architecture:

#### Core-Physics Separation Achievement
- **Complete Property Migration**: All physics properties (including MergTime) now use auto-generated generic accessors
- **Function Simplification**: Core functions (`init_galaxy()`, `deep_copy_galaxy()`) now rely entirely on auto-generated property system functions (`reset_galaxy_properties()`, `copy_galaxy_properties()`)
- **Eliminated Manual Code**: Removed 150+ lines of manual property initialization and synchronization code

#### Property System Maturity
- **"merged" Core Property**: Added for clean galaxy lifecycle management, replacing physics-specific merger properties
- **Property-First Architecture**: Properties are now the authoritative source for all galaxy data
- **Build System Integration**: Seamless integration with physics-free, full-physics, and custom-physics build targets

#### Validation Success
- **Physics-Free Mode**: Builds and runs successfully with core properties only (25/57 properties)
- **No Coupling Violations**: Core infrastructure operates independently of physics property definitions
- **Scientific Accuracy**: Maintains exact scientific algorithms while achieving complete architectural modularity

This auto-generated file system represents a key architectural innovation in SAGE, enabling true modular physics while maintaining scientific accuracy and performance.