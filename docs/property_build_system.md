# SAGE Property Build System

## Overview

SAGE uses an **explicit property build system** that allows you to control which galaxy properties are compiled into the code at build-time. This approach optimises memory usage and execution performance by including only the properties you actually need.

## Build-Time vs Runtime Decision

**The Key Principle**: Property structures and parameter systems are determined at **build-time**, but module configuration happens at **runtime**.

- **Properties**: Defined in `properties.yaml` and compiled into C structures  
- **Parameters**: Defined in `parameters.yaml` and compiled into accessor functions
- **Modules**: Configured via JSON files and loaded at runtime

This separation allows for optimal performance while maintaining configuration flexibility. Both properties and parameters follow the same metadata-driven architecture for consistency.

**ðŸ“– For comprehensive documentation on both property and parameter systems, see [`docs/autogenerated_files_guide.md`](autogenerated_files_guide.md).**

## Explicit Build Targets

### `make physics-free`
**Purpose**: Core-only execution without any physics modules.

**Properties Generated**: Only core properties marked with `is_core: true`
- Galaxy identification (GalaxyIndex, Type, SnapNum)
- Positions and velocities (Pos, Vel)
- Basic halo properties (Mvir, Rvir, etc.)

**Use Cases**:
- Testing core infrastructure
- Property pass-through validation
- Minimal memory usage scenarios
- Core algorithm development

**Memory Impact**: Minimal - only essential properties allocated

### `make full-physics`
**Purpose**: Maximum compatibility with all available physics modules.

**Properties Generated**: All properties from `properties.yaml`
- Core properties + all physics properties
- Star formation histories (SfrDisk, SfrBulge)
- Gas properties (ColdGas, HotGas, etc.)
- All module-specific properties

**Use Cases**:
- Full scientific simulations
- Module development and testing
- Maximum flexibility for runtime configuration
- Production runs with uncertain module requirements

**Memory Impact**: Maximum - all properties allocated regardless of usage

### `make custom-physics CONFIG=file.json`
**Purpose**: Optimised build for specific module configurations.

**Properties Generated**: Core properties + properties required by modules specified in the config file

**Use Cases**:
- Production runs with known module requirements
- Optimised memory usage for specific physics combinations
- Reproducible science with explicit property sets

**Example**:
```bash
make custom-physics CONFIG=input/star_formation_only.json
```

## Usage Examples

### Development Workflow
```bash
# For core infrastructure work
make clean
make physics-free
./sage millennium.par

# For full physics development
make clean  
make full-physics
./sage millennium.par input/full_config.json

# For specific module testing
make clean
make custom-physics CONFIG=input/cooling_only.json
./sage millennium.par input/cooling_only.json
```

### Production Workflow
```bash
# Optimised build for known configuration
make clean
make custom-physics CONFIG=production_config.json
./sage millennium.par production_config.json
```

## Configuration File Requirements

For `custom-physics` builds, your JSON configuration must specify the modules to be used:

```json
{
  "modules": {
    "instances": [
      {
        "name": "CoolingModule",
        "type": "cooling"
      },
      {
        "name": "StarFormationModule", 
        "type": "star_formation"
      }
    ]
  }
}
```

The property generator analyses this configuration to determine which properties are needed.

## Performance Characteristics

| Build Target | Compilation Time | Memory Usage | Runtime Performance | Use Case |
|--------------|------------------|--------------|-------------------|----------|
| `physics-free` | Fastest | Minimal | Fastest | Development/Testing |
| `custom-physics` | Medium | Optimised | Fast | Production |
| `full-physics` | Slowest | Maximum | Good | Development/Flexibility |

## Important Notes

### Recompilation Requirements

**Different property configurations require recompilation.** Always run `make clean` when switching between build targets:

```bash
# CORRECT workflow
make clean
make physics-free
# ... test core functionality
make clean  
make full-physics
# ... test with physics modules
```

### Property Warnings

When properties are missing (e.g., using `physics-free` but referencing physics properties), you may see warnings like:
```
Warning: Unknown property type 'float[STEPS]' for property 'SfrDisk'. Defaulting to float.
```

This is normal and indicates the property system is working correctly - physics properties are not available in physics-free mode.

### Stamp File System

The build system uses stamp files (`.stamps/generate_properties_*.stamp`) to track which property configuration was last generated. The clean target removes these automatically.

## Integration with Module System

The property build system is independent of but compatible with the module system:

1. **Build-time**: Properties are generated based on intended module usage
2. **Runtime**: Modules are loaded based on JSON configuration
3. **Validation**: System ensures loaded modules have their required properties available

## Troubleshooting

### Problem: "Property not found" errors
**Solution**: Ensure your build target includes the required properties. Use `full-physics` for maximum compatibility.

### Problem: Memory usage too high
**Solution**: Use `custom-physics` with a minimal configuration, or `physics-free` for core-only work.

### Problem: Module loading fails
**Solution**: Verify your JSON configuration matches your build target. Modules requiring specific properties need those properties to be built.

### Problem: Build fails after switching targets
**Solution**: Always run `make clean` before switching between different property build targets.

## Future Extensions

The explicit build system provides a foundation for:
- Build-time module validation
- Automated property dependency analysis  
- Performance profiling by property set
- Custom property subsets for specific science cases

## Help

For a quick reference of available targets:
```bash
make help
```

This displays all build targets with usage examples.
